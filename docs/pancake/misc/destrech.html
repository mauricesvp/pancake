<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>pancake.misc.destrech API documentation</title>
<meta name="description" content="This script tries to destrech the left and right side of the Panorama Camera.
Note that this approach was dropped and is no longer supported,
so this …" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>pancake.misc.destrech</code></h1>
</header>
<section id="section-intro">
<p>This script tries to destrech the left and right side of the Panorama Camera.
Note that this approach was dropped and is no longer supported,
so this script will probably not produce usable results.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
This script tries to destrech the left and right side of the Panorama Camera.
Note that this approach was dropped and is no longer supported,
so this script will probably not produce usable results.
&#34;&#34;&#34;
import argparse

import cv2
import numpy as np

# Constants (or hard coded values)
# YOU MAY HAVE TO CHANGE VALUES HERE IF RESULTS ARE UNEXPECTED

# Calc bt: bt = final_y // BORDER_BTTM_&lt;LEFT/RIGHT&gt;
BORDER_BTTM_LEFT = 2.376
BORDER_BTTM_RIGHT = 2.483

# ROI (Region of Interest)
# These points are relative, so any image resolution will work
PTS_LEFT = [
    [656 / 1280, 288 / 720],
    [1279 / 1280, 208 / 720],
    [1279 / 1280, 432 / 720],
    [537 / 1280, 397 / 720],
]
PTS_RIGHT = [
    [1 / 1280, 215 / 720],
    [925 / 1280, 331 / 720],
    [1006 / 1280, 388 / 720],
    [1 / 1280, 449 / 720],
]


def process_side(img, pts1, path: str, border=True, write=True, left=True):
    &#34;&#34;&#34;Process one side.

    img: input image
    pts1: ROI (Region of Interest)
    border: Fill border around image to match shape of img
    write: Write to file
    left: Left side of image
    &#34;&#34;&#34;
    final_y, final_x, _ = img.shape
    # Right side covers a lot more space
    if not left:
        final_x = int(3 * final_x)
    # Max distance of width, height
    # In other words, how large is the smallest rectangle that fits around all 4 points of pts1
    xs = [x[0] for x in pts1]
    ys = [x[1] for x in pts1]
    # mw = int(max(xs) - min(xs))
    # We don&#39;t really need a border on the outer side
    mw = final_x
    mh = int(max(ys) - min(ys))
    pts2 = [
        [0, 0],
        [mw, 0],
        [mw, mh],
        [0, mh],
    ]
    pts2 = np.float32(pts2)

    M = cv2.getPerspectiveTransform(pts1, pts2)
    img = cv2.warpPerspective(img, M, (mw, mh))

    if border:
        factor = BORDER_BTTM_LEFT if left else BORDER_BTTM_RIGHT
        bt = round(final_y // factor)
        tp = round(final_y - bt - mh)
        if left:
            lt = final_x - mw
            rt = 0
        else:
            lt = 0
            rt = final_x - mw
        # Fill up missing space
        img = cv2.copyMakeBorder(
            img, tp, bt, lt, rt, cv2.BORDER_CONSTANT, None, (0, 0, 0)
        )

    if write:
        suffix = &#34;l&#34; if left else &#34;r&#34;
        print(path)
        cv2.imwrite(f&#34;{path}/destreched_{suffix}.jpg&#34;, img)
    return img


def main(path: str):
    &#34;&#34;&#34;Destrech and stitch panorama image.&#34;&#34;&#34;
    if path.endswith(&#34;/&#34;):
        path = path[:-1]
    left = cv2.imread(f&#34;{path}/1l.jpg&#34;)
    center = cv2.imread(f&#34;{path}/1c.jpg&#34;)
    right = cv2.imread(f&#34;{path}/1r.jpg&#34;)

    target_y, target_x, _ = center.shape

    # Undo overlapping of images by cropping 0.5% of the width
    # This could be slightly more precise I guess
    width_l = left.shape[1]
    # Crop at the right
    crop_l = left[:, : width_l - (width_l // 200)]
    destr_l = cv2.resize(crop_l, (target_x, target_y))
    width_r = right.shape[1]
    # Crop at the left
    crop_r = right[:, (width_r // 200) :]
    destr_r = cv2.resize(crop_r, (target_x, target_y))

    # LEFT
    pts_left = PTS_LEFT
    for x in pts_left:
        x[0] *= target_x
        x[1] *= target_y
    pts_left = np.float32(pts_left)
    left_image = process_side(destr_l, pts_left, path=path, border=False, write=True)
    # RIGHT
    pts_right = PTS_RIGHT
    for x in pts_right:
        x[0] *= target_x
        x[1] *= target_y
    pts_right = np.float32(pts_right)
    right_image = process_side(destr_r, pts_right, left=False, path=path)

    # Finally, stitch together
    stitched = cv2.hconcat([left_image, center, right_image])
    cv2.imwrite(f&#34;{path}/stitched.jpg&#34;, stitched)


if __name__ == &#34;__main__&#34;:
    parser = argparse.ArgumentParser()
    parser.add_argument(
        &#34;path&#34;, type=str, nargs=&#34;?&#34;, default=&#34;../samples/images/random1&#34;
    )
    args = parser.parse_args()
    main(args.path)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="pancake.misc.destrech.main"><code class="name flex">
<span>def <span class="ident">main</span></span>(<span>path: str)</span>
</code></dt>
<dd>
<div class="desc"><p>Destrech and stitch panorama image.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def main(path: str):
    &#34;&#34;&#34;Destrech and stitch panorama image.&#34;&#34;&#34;
    if path.endswith(&#34;/&#34;):
        path = path[:-1]
    left = cv2.imread(f&#34;{path}/1l.jpg&#34;)
    center = cv2.imread(f&#34;{path}/1c.jpg&#34;)
    right = cv2.imread(f&#34;{path}/1r.jpg&#34;)

    target_y, target_x, _ = center.shape

    # Undo overlapping of images by cropping 0.5% of the width
    # This could be slightly more precise I guess
    width_l = left.shape[1]
    # Crop at the right
    crop_l = left[:, : width_l - (width_l // 200)]
    destr_l = cv2.resize(crop_l, (target_x, target_y))
    width_r = right.shape[1]
    # Crop at the left
    crop_r = right[:, (width_r // 200) :]
    destr_r = cv2.resize(crop_r, (target_x, target_y))

    # LEFT
    pts_left = PTS_LEFT
    for x in pts_left:
        x[0] *= target_x
        x[1] *= target_y
    pts_left = np.float32(pts_left)
    left_image = process_side(destr_l, pts_left, path=path, border=False, write=True)
    # RIGHT
    pts_right = PTS_RIGHT
    for x in pts_right:
        x[0] *= target_x
        x[1] *= target_y
    pts_right = np.float32(pts_right)
    right_image = process_side(destr_r, pts_right, left=False, path=path)

    # Finally, stitch together
    stitched = cv2.hconcat([left_image, center, right_image])
    cv2.imwrite(f&#34;{path}/stitched.jpg&#34;, stitched)</code></pre>
</details>
</dd>
<dt id="pancake.misc.destrech.process_side"><code class="name flex">
<span>def <span class="ident">process_side</span></span>(<span>img, pts1, path: str, border=True, write=True, left=True)</span>
</code></dt>
<dd>
<div class="desc"><p>Process one side.</p>
<p>img: input image
pts1: ROI (Region of Interest)
border: Fill border around image to match shape of img
write: Write to file
left: Left side of image</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def process_side(img, pts1, path: str, border=True, write=True, left=True):
    &#34;&#34;&#34;Process one side.

    img: input image
    pts1: ROI (Region of Interest)
    border: Fill border around image to match shape of img
    write: Write to file
    left: Left side of image
    &#34;&#34;&#34;
    final_y, final_x, _ = img.shape
    # Right side covers a lot more space
    if not left:
        final_x = int(3 * final_x)
    # Max distance of width, height
    # In other words, how large is the smallest rectangle that fits around all 4 points of pts1
    xs = [x[0] for x in pts1]
    ys = [x[1] for x in pts1]
    # mw = int(max(xs) - min(xs))
    # We don&#39;t really need a border on the outer side
    mw = final_x
    mh = int(max(ys) - min(ys))
    pts2 = [
        [0, 0],
        [mw, 0],
        [mw, mh],
        [0, mh],
    ]
    pts2 = np.float32(pts2)

    M = cv2.getPerspectiveTransform(pts1, pts2)
    img = cv2.warpPerspective(img, M, (mw, mh))

    if border:
        factor = BORDER_BTTM_LEFT if left else BORDER_BTTM_RIGHT
        bt = round(final_y // factor)
        tp = round(final_y - bt - mh)
        if left:
            lt = final_x - mw
            rt = 0
        else:
            lt = 0
            rt = final_x - mw
        # Fill up missing space
        img = cv2.copyMakeBorder(
            img, tp, bt, lt, rt, cv2.BORDER_CONSTANT, None, (0, 0, 0)
        )

    if write:
        suffix = &#34;l&#34; if left else &#34;r&#34;
        print(path)
        cv2.imwrite(f&#34;{path}/destreched_{suffix}.jpg&#34;, img)
    return img</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="pancake.misc" href="index.html">pancake.misc</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="pancake.misc.destrech.main" href="#pancake.misc.destrech.main">main</a></code></li>
<li><code><a title="pancake.misc.destrech.process_side" href="#pancake.misc.destrech.process_side">process_side</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>